<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AutomaticDrawStrategy.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">io.github.redouanebali.generation.draw</a> &gt; <span class="el_source">AutomaticDrawStrategy.java</span></div><h1>AutomaticDrawStrategy.java</h1><pre class="source lang-java linenums">package io.github.redouanebali.generation.draw;

import io.github.redouanebali.generation.util.ByePlacementUtil;
import io.github.redouanebali.generation.util.RandomPlacementUtil;
import io.github.redouanebali.generation.util.SeedPlacementUtil;
import io.github.redouanebali.model.Game;
import io.github.redouanebali.model.PlayerPair;
import io.github.redouanebali.model.Pool;
import io.github.redouanebali.model.Round;
import io.github.redouanebali.model.Stage;
import io.github.redouanebali.model.Tournament;
import io.github.redouanebali.model.format.TournamentFormat;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

<span class="fc" id="L19">public class AutomaticDrawStrategy implements DrawStrategy {</span>

  @Override
  public void placePlayers(Tournament tournament, List&lt;PlayerPair&gt; players) {
<span class="fc bfc" id="L23" title="All 6 branches covered.">    if (tournament == null || players == null || players.isEmpty()) {</span>
<span class="fc" id="L24">      return;</span>
    }

<span class="fc" id="L27">    List&lt;Round&gt; rounds = tournament.getRounds();</span>
<span class="pc bpc" id="L28" title="1 of 4 branches missed.">    if (rounds == null || rounds.isEmpty()) {</span>
<span class="fc" id="L29">      return;</span>
    }

<span class="fc" id="L32">    fillInitialRoundsAutomatic(tournament, players);</span>
<span class="fc" id="L33">  }</span>

  /**
   * Automatically fills the initial rounds of the tournament with logic moved from TournamentBuilder.
   */
  private void fillInitialRoundsAutomatic(Tournament tournament, List&lt;PlayerPair&gt; allPairs) {
<span class="fc" id="L39">    List&lt;Round&gt; rounds = tournament.getRounds();</span>

    // Find the first qualification round (Q1) and first main draw round
<span class="fc" id="L42">    Round firstQualifRound   = null;</span>
<span class="fc" id="L43">    Round firstMainDrawRound = null;</span>

<span class="fc bfc" id="L45" title="All 2 branches covered.">    for (Round round : rounds) {</span>
<span class="fc" id="L46">      Stage stage = round.getStage();</span>

      // Find Q1 (first qualification round)
<span class="pc bpc" id="L49" title="1 of 6 branches missed.">      if ((stage == Stage.Q1 || stage == Stage.GROUPS) &amp;&amp; firstQualifRound == null) {</span>
<span class="fc" id="L50">        firstQualifRound = round;</span>
      }

      // Find first main draw round (largest stage present)
<span class="fc bfc" id="L54" title="All 6 branches covered.">      if (!stage.isQualification() &amp;&amp; stage != Stage.GROUPS &amp;&amp; firstMainDrawRound == null) {</span>
<span class="fc" id="L55">        firstMainDrawRound = round;</span>
      }
<span class="fc" id="L57">    }</span>

    // Process Q1 or Groups if present
<span class="fc bfc" id="L60" title="All 2 branches covered.">    if (firstQualifRound != null) {</span>
<span class="fc" id="L61">      processInitialRound(tournament, firstQualifRound, allPairs);</span>
    }

    // Process first main draw round if present
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">    if (firstMainDrawRound != null) {</span>
<span class="fc" id="L66">      processInitialRound(tournament, firstMainDrawRound, allPairs);</span>
    }
<span class="fc" id="L68">  }</span>

  /**
   * Processes an initial round with automatic logic.
   */
  private void processInitialRound(Tournament tournament, Round initialRound, List&lt;PlayerPair&gt; allPairs) {
<span class="fc" id="L74">    int   roundDrawSize   = initialRound.getGames().size() * 2;</span>
<span class="fc" id="L75">    int   configuredSeeds = tournament.getConfig().getNbSeeds();</span>
<span class="fc" id="L76">    Stage stage           = initialRound.getStage();</span>

<span class="fc bfc" id="L78" title="All 2 branches covered.">    if (stage.isQualification()) {</span>
<span class="fc" id="L79">      processQualificationRound(tournament, initialRound, allPairs, roundDrawSize);</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">    } else if (stage == Stage.GROUPS) {</span>
<span class="fc" id="L81">      processGroupsRound(tournament, initialRound, allPairs);</span>
    } else {
<span class="fc" id="L83">      processMainDrawRound(tournament, initialRound, allPairs, roundDrawSize, configuredSeeds);</span>
    }

<span class="fc" id="L86">  }</span>


  /**
   * Processes a qualification round with automatic logic.
   */
  private void processQualificationRound(Tournament tournament, Round initialRound, List&lt;PlayerPair&gt; allPairs, int qualifDrawSize) {
<span class="fc" id="L93">    int nbSeedsQualif = tournament.getConfig().getNbSeedsQualify();</span>

    // Calculate how many teams participate in qualifs vs direct entry to main draw
<span class="fc" id="L96">    int totalSlotsInMainDraw    = tournament.getConfig().getMainDrawSize();</span>
<span class="fc" id="L97">    int nbQualifiers            = tournament.getConfig().getNbQualifiers();</span>
<span class="fc" id="L98">    int directEntriesToMainDraw = totalSlotsInMainDraw - nbQualifiers;</span>

    // Teams that go directly to main draw (best ranked)
<span class="fc" id="L101">    int teamsNotInQualifs = Math.min(directEntriesToMainDraw, allPairs.size());</span>

    // Remaining teams that compete in qualifs
<span class="fc" id="L104">    int teamsAvailableForQualifs = Math.max(0, allPairs.size() - teamsNotInQualifs);</span>
<span class="fc" id="L105">    int byesNeededInQualifs      = Math.max(0, qualifDrawSize - teamsAvailableForQualifs);</span>

    // Determine teams to protect with BYES in qualifs
<span class="fc" id="L108">    int teamsToProtectInQualifs = Math.max(nbSeedsQualif, byesNeededInQualifs);</span>

    // Get teams that participate in qualifs
<span class="fc" id="L111">    List&lt;PlayerPair&gt; qualifParticipants = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L112">    int              startIndex         = Math.max(0, allPairs.size() - teamsAvailableForQualifs);</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">    for (int i = startIndex; i &lt; allPairs.size(); i++) {</span>
<span class="fc" id="L114">      qualifParticipants.add(allPairs.get(i));</span>
    }

    // Place seeds in qualifs (among qualif participants only)
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">    if (nbSeedsQualif &gt; 0 &amp;&amp; !qualifParticipants.isEmpty()) {</span>
<span class="nc" id="L119">      SeedPlacementUtil.placeSeedTeams(initialRound, qualifParticipants, nbSeedsQualif, qualifDrawSize);</span>
    }

    // Place BYEs in qualifs if necessary
<span class="fc bfc" id="L123" title="All 2 branches covered.">    if (byesNeededInQualifs &gt; 0) {</span>
<span class="fc" id="L124">      ByePlacementUtil.placeByeTeams(initialRound, teamsAvailableForQualifs, nbSeedsQualif, qualifDrawSize);</span>
    }

    // Place remaining qualif participants randomly
<span class="fc" id="L128">    List&lt;PlayerPair&gt; remainingQualifTeams = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">    for (int i = teamsToProtectInQualifs; i &lt; qualifParticipants.size(); i++) {</span>
<span class="fc" id="L130">      remainingQualifTeams.add(qualifParticipants.get(i));</span>
    }
<span class="fc" id="L132">    RandomPlacementUtil.placeRemainingTeamsRandomly(initialRound, remainingQualifTeams);</span>
<span class="fc" id="L133">  }</span>

  /**
   * Répartit les joueurs dans nbPools groupes et génère les matchs de poule (round robin) dans le round GROUPS.
   */
  private void processGroupsRound(Tournament tournament, Round round, List&lt;PlayerPair&gt; allPairs) {
<span class="fc" id="L139">    int nbPools           = tournament.getConfig().getNbPools();</span>
<span class="fc" id="L140">    int nbPairsPerPool    = tournament.getConfig().getNbPairsPerPool();</span>
<span class="fc" id="L141">    int nbQualifiedByPool = tournament.getConfig().getNbQualifiedByPool();</span>
<span class="pc bpc" id="L142" title="4 of 8 branches missed.">    if (nbPools &lt;= 0 || nbPairsPerPool &lt;= 0 || allPairs == null || allPairs.isEmpty()) {</span>
<span class="nc" id="L143">      return;</span>
    }
    // Sépare les seeds des autres paires
<span class="fc" id="L146">    List&lt;PlayerPair&gt; seeds  = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L147">    List&lt;PlayerPair&gt; others = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">    for (PlayerPair pair : allPairs) {</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">      if (pair.getSeed() &gt; 0) {</span>
<span class="fc" id="L150">        seeds.add(pair);</span>
      } else {
<span class="nc" id="L152">        others.add(pair);</span>
      }
<span class="fc" id="L154">    }</span>
    // Placement des seeds dans les pools selon le snake officiel
<span class="fc" id="L156">    List&lt;List&lt;PlayerPair&gt;&gt; pools = SeedPlacementUtil.placeSeedsInPoolsSnake(seeds, nbPools);</span>
    // Complète les pools avec les autres paires
<span class="fc" id="L158">    int idx = 0;</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">    for (int p = 0; p &lt; nbPools; p++) {</span>
<span class="pc bpc" id="L160" title="3 of 4 branches missed.">      while (pools.get(p).size() &lt; nbPairsPerPool &amp;&amp; idx &lt; others.size()) {</span>
<span class="nc" id="L161">        pools.get(p).add(others.get(idx));</span>
<span class="nc" id="L162">        idx++;</span>
      }
    }
    // Affectation des paires aux pools du round
<span class="fc" id="L166">    assignPairsToPools(round, pools);</span>
    // Génération des matchs round robin pour chaque poule
<span class="fc" id="L168">    List&lt;Game&gt; games = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">    for (List&lt;PlayerPair&gt; pool : pools) {</span>
<span class="fc" id="L170">      int n = pool.size();</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">      for (int i = 0; i &lt; n; i++) {</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">        for (int j = i + 1; j &lt; n; j++) {</span>
<span class="fc" id="L173">          Game g = new Game();</span>
<span class="fc" id="L174">          g.setTeamA(pool.get(i));</span>
<span class="fc" id="L175">          g.setTeamB(pool.get(j));</span>
<span class="fc" id="L176">          g.setFormat(round.getMatchFormat());</span>
<span class="fc" id="L177">          games.add(g);</span>
        }
      }
<span class="fc" id="L180">    }</span>
<span class="fc" id="L181">    round.getGames().clear();</span>
<span class="fc" id="L182">    round.getGames().addAll(games);</span>
<span class="fc" id="L183">  }</span>

  /**
   * Remplit les pools du round avec les paires affectées.
   */
  private void assignPairsToPools(Round round, List&lt;List&lt;PlayerPair&gt;&gt; poolsPairs) {
<span class="fc" id="L189">    round.getPools().clear();</span>
<span class="fc" id="L190">    char poolName = 'A';</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">    for (List&lt;PlayerPair&gt; pairs : poolsPairs) {</span>
<span class="fc" id="L192">      Pool pool = new Pool(&quot;Pool &quot; + poolName, pairs);</span>
<span class="fc" id="L193">      round.getPools().add(pool);</span>
<span class="fc" id="L194">      poolName++;</span>
<span class="fc" id="L195">    }</span>
<span class="fc" id="L196">  }</span>

  /**
   * Processes a main draw round with automatic logic.
   */
  private void processMainDrawRound(Tournament tournament, Round initialRound, List&lt;PlayerPair&gt; allPairs, int roundDrawSize, int configuredSeeds) {
    // Step 1: Place seeds
<span class="fc" id="L203">    SeedPlacementUtil.placeSeedTeams(initialRound, allPairs, configuredSeeds, roundDrawSize);</span>

    // Step 2: Place BYEs for direct entries only, skipping qualifier slots
<span class="fc" id="L206">    int nbQualifiers  = tournament.getConfig().getNbQualifiers();</span>
<span class="fc" id="L207">    int totalSlots    = tournament.getConfig().getMainDrawSize();</span>
<span class="fc" id="L208">    int directEntries = Math.min(totalSlots - nbQualifiers, allPairs.size());</span>
<span class="fc" id="L209">    ByePlacementUtil.placeByeTeams(initialRound, directEntries, configuredSeeds, roundDrawSize, nbQualifiers);</span>

    // Step 3: Place qualifiers randomly in available slots
<span class="fc" id="L212">    RandomPlacementUtil.placeQualifiers(initialRound, nbQualifiers);</span>

    // Step 4: Place remaining teams randomly in available slots
<span class="fc" id="L215">    Set&lt;PlayerPair&gt; alreadyPlaced = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">    for (Game g : initialRound.getGames()) {</span>
<span class="fc bfc" id="L217" title="All 6 branches covered.">      if (g.getTeamA() != null &amp;&amp; !g.getTeamA().isBye() &amp;&amp; !g.getTeamA().isQualifier()) {</span>
<span class="fc" id="L218">        alreadyPlaced.add(g.getTeamA());</span>
      }
<span class="fc bfc" id="L220" title="All 6 branches covered.">      if (g.getTeamB() != null &amp;&amp; !g.getTeamB().isBye() &amp;&amp; !g.getTeamB().isQualifier()) {</span>
<span class="fc" id="L221">        alreadyPlaced.add(g.getTeamB());</span>
      }
<span class="fc" id="L223">    }</span>
<span class="fc" id="L224">    List&lt;PlayerPair&gt; remainingTeams = allPairs.stream()</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">                                              .filter(p -&gt; !alreadyPlaced.contains(p))</span>
<span class="fc" id="L226">                                              .limit(directEntries)</span>
<span class="fc" id="L227">                                              .collect(Collectors.toList());</span>
<span class="fc" id="L228">    RandomPlacementUtil.placeRemainingTeamsRandomly(initialRound, remainingTeams);</span>
<span class="fc" id="L229">  }</span>

  /**
   * Calculates how many teams actually participate in the main draw. This accounts for teams that go to qualifications vs direct entry.
   */
  private int calculateMainDrawParticipants(Tournament tournament, List&lt;PlayerPair&gt; allPairs) {
<span class="nc bnc" id="L235" title="All 2 branches missed.">    if (tournament.getConfig().getFormat() == TournamentFormat.KNOCKOUT) {</span>
<span class="nc" id="L236">      return tournament.getConfig().getMainDrawSize();</span>
    }
<span class="nc" id="L238">    int totalSlots   = tournament.getConfig().getMainDrawSize();</span>
<span class="nc" id="L239">    int nbQualifiers = tournament.getConfig().getNbQualifiers();</span>

<span class="nc bnc" id="L241" title="All 2 branches missed.">    if (nbQualifiers &gt; 0) {</span>
      // Tournament has qualifications
      // Direct entries = total slots - qualifier spots
<span class="nc" id="L244">      int directEntries = totalSlots - nbQualifiers;</span>
<span class="nc" id="L245">      return Math.min(directEntries, allPairs.size());</span>
    } else {
      // No qualifications, all teams go to main draw
<span class="nc" id="L248">      return Math.min(allPairs.size(), totalSlots);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>