<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Game.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">io.github.redouanebali.model</a> &gt; <span class="el_source">Game.java</span></div><h1>Game.java</h1><pre class="source lang-java linenums">package io.github.redouanebali.model;

import com.fasterxml.jackson.annotation.JsonFormat;
import jakarta.persistence.CascadeType;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.OneToOne;
import java.time.LocalTime;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import org.springframework.format.annotation.DateTimeFormat;

@Entity
@Getter
@Setter
@AllArgsConstructor
@NoArgsConstructor(force = true)
public class Game {

  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  private Long id;

  @ManyToOne(cascade = CascadeType.PERSIST)
  @JoinColumn(name = &quot;teama_id&quot;)
  private PlayerPair teamA;

  @ManyToOne(cascade = CascadeType.PERSIST)
  @JoinColumn(name = &quot;teamb_id&quot;)
  private PlayerPair teamB;

  @OneToOne(cascade = CascadeType.ALL, orphanRemoval = true)
  private Score score;

  @ManyToOne(fetch = FetchType.EAGER)
  @JoinColumn(name = &quot;format_id&quot;)
  private MatchFormat format;

  @Enumerated(EnumType.STRING)
  private TeamSide winnerSide;

  @DateTimeFormat(pattern = &quot;HH:mm&quot;)
  @JsonFormat(pattern = &quot;HH:mm&quot;)
  private LocalTime scheduledTime;

  private String court;

  @ManyToOne
  @JoinColumn(name = &quot;pool_id&quot;)
  private Pool pool;

<span class="fc" id="L61">  public Game(MatchFormat format) {</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">    if (format == null) {</span>
<span class="nc" id="L63">      throw new IllegalArgumentException(&quot;Le format du match ne peut pas être null&quot;);</span>
    }
<span class="fc" id="L65">    this.format = format;</span>
<span class="fc" id="L66">  }</span>

  public boolean isFinished() {
    // BYE handling using PlayerPair.isBye()
<span class="fc bfc" id="L70" title="All 4 branches covered.">    boolean aBye = teamA != null &amp;&amp; teamA.isBye();</span>
<span class="fc bfc" id="L71" title="All 4 branches covered.">    boolean bBye = teamB != null &amp;&amp; teamB.isBye();</span>

    // Both BYE → consider finished (no meaningful winner)
<span class="pc bpc" id="L74" title="1 of 4 branches missed.">    if (aBye &amp;&amp; bBye) {</span>
<span class="nc" id="L75">      return true;</span>
    }
    // Exactly one BYE with a real opponent present → finished (auto-qualify the non-BYE side)
<span class="pc bpc" id="L78" title="4 of 12 branches missed.">    if ((aBye &amp;&amp; teamB != null &amp;&amp; !bBye) || (bBye &amp;&amp; teamA != null &amp;&amp; !aBye)) {</span>
<span class="fc" id="L79">      return true;</span>
    }

    // Fall back to score-based completion
<span class="pc bpc" id="L83" title="1 of 4 branches missed.">    if (score == null || score.getSets().isEmpty()) {</span>
<span class="fc" id="L84">      return false;</span>
    }

<span class="fc" id="L87">    int     teamAWonSets = 0;</span>
<span class="fc" id="L88">    int     teamBWonSets = 0;</span>
<span class="fc" id="L89">    int     setsToWin    = format.getNumberOfSetsToWin();</span>
<span class="fc" id="L90">    int     pointsPerSet = format.getGamesPerSet();</span>
<span class="fc" id="L91">    boolean superTie     = format.isSuperTieBreakInFinalSet();</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">    for (int i = 0; i &lt; score.getSets().size(); i++) {</span>
<span class="fc" id="L94">      SetScore set        = score.getSets().get(i);</span>
<span class="fc bfc" id="L95" title="All 6 branches covered.">      boolean  isFinalSet = (i == score.getSets().size() - 1) &amp;&amp; (teamAWonSets == setsToWin - 1) &amp;&amp; (teamBWonSets == setsToWin - 1);</span>

<span class="fc bfc" id="L97" title="All 4 branches covered.">      if (isFinalSet &amp;&amp; superTie) {</span>
<span class="fc" id="L98">        int a = set.getTeamAScore();</span>
<span class="fc" id="L99">        int b = set.getTeamBScore();</span>
<span class="fc bfc" id="L100" title="All 6 branches covered.">        if ((a &gt;= 10 || b &gt;= 10) &amp;&amp; Math.abs(a - b) &gt;= 2) {</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">          if (a &gt; b) {</span>
<span class="fc" id="L102">            teamAWonSets++;</span>
          } else {
<span class="fc" id="L104">            teamBWonSets++;</span>
          }
        }
<span class="fc" id="L107">      } else {</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (isSetWonBy(set.getTeamAScore(), set.getTeamBScore(), pointsPerSet)) {</span>
<span class="fc" id="L109">          teamAWonSets++;</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">        } else if (isSetWonBy(set.getTeamBScore(), set.getTeamAScore(), pointsPerSet)) {</span>
<span class="fc" id="L111">          teamBWonSets++;</span>
        }
      }
    }

<span class="fc bfc" id="L116" title="All 4 branches covered.">    return teamAWonSets &gt;= setsToWin || teamBWonSets &gt;= setsToWin;</span>
  }

  public boolean isSetWonBy(int teamScore, int opponentScore, int maxPointsPerSet) {
<span class="fc bfc" id="L120" title="All 2 branches covered.">    if (teamScore &lt; maxPointsPerSet) {</span>
<span class="fc" id="L121">      return false;</span>
    }

    // If both teams reached maxPointsPerSet - 1, play up to maxPointsPerSet + 1
<span class="fc" id="L125">    int tieThreshold = maxPointsPerSet - 1;</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">    if (opponentScore &gt;= tieThreshold) {</span>
<span class="pc bpc" id="L127" title="1 of 4 branches missed.">      return teamScore == maxPointsPerSet + 1 &amp;&amp; (teamScore - opponentScore) &gt;= 1;</span>
    }

    // Otherwise, 2 points difference needed after reaching maxPointsPerSet
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">    return (teamScore - opponentScore) &gt;= 2;</span>
  }


  public PlayerPair getWinner() {
    // Resolve BYE first using PlayerPair.isBye()
<span class="fc bfc" id="L137" title="All 4 branches covered.">    boolean aBye = teamA != null &amp;&amp; teamA.isBye();</span>
<span class="fc bfc" id="L138" title="All 4 branches covered.">    boolean bBye = teamB != null &amp;&amp; teamB.isBye();</span>
<span class="fc bfc" id="L139" title="All 4 branches covered.">    if (aBye &amp;&amp; !bBye) {</span>
<span class="fc" id="L140">      return teamB;</span>
    }
<span class="fc bfc" id="L142" title="All 4 branches covered.">    if (bBye &amp;&amp; !aBye) {</span>
<span class="fc" id="L143">      return teamA;</span>
    }
<span class="pc bpc" id="L145" title="1 of 4 branches missed.">    if (aBye &amp;&amp; bBye) {</span>
<span class="fc" id="L146">      return this.getTeamA();</span>
    }

<span class="fc bfc" id="L149" title="All 2 branches covered.">    if (!isFinished()) {</span>
<span class="fc" id="L150">      return null;</span>
    }

<span class="fc" id="L153">    int setsWonByA = 0;</span>
<span class="fc" id="L154">    int setsWonByB = 0;</span>

<span class="fc bfc" id="L156" title="All 2 branches covered.">    for (SetScore set : score.getSets()) {</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">      if (set.getTeamAScore() &gt; set.getTeamBScore()) {</span>
<span class="fc" id="L158">        setsWonByA++;</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">      } else if (set.getTeamBScore() &gt; set.getTeamAScore()) {</span>
<span class="fc" id="L160">        setsWonByB++;</span>
      }
<span class="fc" id="L162">    }</span>

<span class="fc bfc" id="L164" title="All 2 branches covered.">    return setsWonByA &gt; setsWonByB ? teamA : teamB;</span>
  }

  public void setScore(Score score) {
<span class="fc" id="L168">    this.score = score;</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">    if (this.isFinished()) {</span>
<span class="fc" id="L170">      PlayerPair winner = getWinner();</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">      if (winner == null) {</span>
<span class="nc" id="L172">        this.winnerSide = null;</span>
      } else {
<span class="fc bfc" id="L174" title="All 2 branches covered.">        this.winnerSide = winner.equals(teamA) ? TeamSide.TEAM_A : TeamSide.TEAM_B;</span>
      }
<span class="fc" id="L176">    } else {</span>
<span class="fc" id="L177">      this.winnerSide = null;</span>
    }
<span class="fc" id="L179">  }</span>

  @Override
  public String toString() {
<span class="nc" id="L183">    return String.format(</span>
        &quot;%s vs %s&quot;,
<span class="nc bnc" id="L185" title="All 2 branches missed.">        teamA != null ? teamA.toString() : &quot;?&quot;,</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        teamB != null ? teamB.toString() : &quot;?&quot;</span>
    );
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>